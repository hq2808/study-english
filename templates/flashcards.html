{% extends "base.html" %}

{% block title %}Flashcards - Smart English Learning{% endblock %}

{% block nav_flashcards %}bg-white/10 text-white{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <!-- Header -->
    <div class="text-center mb-8">
        <h1 class="text-4xl font-bold gradient-text mb-4">Flashcard Review</h1>
        <p class="text-gray-400">Review and memorize your saved vocabulary</p>
    </div>

    <!-- Stats -->
    <div class="grid grid-cols-3 gap-4 mb-8">
        <div class="glass-dark rounded-2xl p-6 text-center glow-sm">
            <div class="text-3xl font-bold text-primary-400" id="total-cards">0</div>
            <div class="text-gray-400 text-sm">Total Cards</div>
        </div>
        <div class="glass-dark rounded-2xl p-6 text-center glow-sm">
            <div class="text-3xl font-bold text-accent-400" id="reviewed-today">0</div>
            <div class="text-gray-400 text-sm">Reviewed Today</div>
        </div>
        <div class="glass-dark rounded-2xl p-6 text-center glow-sm">
            <div class="text-3xl font-bold text-green-400" id="mastered">0</div>
            <div class="text-gray-400 text-sm">Mastered (5+ reviews)</div>
        </div>
    </div>

    <!-- Empty State -->
    <div id="empty-state" class="hidden glass-dark rounded-2xl p-12 text-center glow">
        <div
            class="w-24 h-24 mx-auto mb-6 rounded-2xl bg-gradient-to-br from-gray-600 to-gray-700 flex items-center justify-center">
            <svg class="w-12 h-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10">
                </path>
            </svg>
        </div>
        <h2 class="text-2xl font-bold text-white mb-4">No flashcards yet!</h2>
        <p class="text-gray-400 mb-6">Start reading lessons and save words to build your vocabulary collection.</p>
        <a href="/"
            class="inline-flex items-center space-x-2 btn-glow bg-gradient-to-r from-primary-500 to-accent-500 text-white py-3 px-6 rounded-xl font-medium">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253">
                </path>
            </svg>
            <span>Go to Lessons</span>
        </a>
    </div>

    <!-- Flashcard Container -->
    <div id="flashcard-section" class="hidden">
        <!-- Progress -->
        <div class="flex items-center justify-between mb-6">
            <span class="text-gray-400">Card <span id="current-index">1</span> of <span id="card-count">0</span></span>
            <div class="flex space-x-2">
                <button id="shuffle-btn"
                    class="px-4 py-2 rounded-lg bg-white/10 hover:bg-white/20 text-gray-300 transition-all flex items-center space-x-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15">
                        </path>
                    </svg>
                    <span>Shuffle</span>
                </button>
            </div>
        </div>

        <!-- Flashcard -->
        <div class="flashcard-container mb-8">
            <div id="flashcard" class="flashcard cursor-pointer">
                <div class="flashcard-front shadow-2xl">
                    <span id="card-level"
                        class="absolute top-4 right-4 px-3 py-1 rounded-full text-xs font-bold text-white bg-white/20"></span>
                    <p id="card-word" class="text-4xl font-bold text-white mb-4"></p>
                    <p class="text-white/60 text-sm">Click to reveal translation</p>
                </div>
                <div class="flashcard-back shadow-2xl">
                    <p id="card-translation" class="text-3xl font-bold text-white mb-4"></p>
                    <p id="card-context" class="text-white/60 text-sm"></p>
                </div>
            </div>
        </div>

        <!-- Controls -->
        <div class="flex items-center justify-center space-x-4 mb-8">
            <button id="prev-btn"
                class="w-14 h-14 rounded-full bg-white/10 hover:bg-white/20 text-white transition-all flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                </svg>
            </button>

            <button id="speak-btn"
                class="w-16 h-16 rounded-full bg-gradient-to-r from-primary-500 to-primary-600 hover:from-primary-400 hover:to-primary-500 text-white transition-all flex items-center justify-center glow">
                <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z">
                    </path>
                </svg>
            </button>

            <button id="review-btn"
                class="w-16 h-16 rounded-full bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-400 hover:to-emerald-500 text-white transition-all flex items-center justify-center">
                <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                </svg>
            </button>

            <button id="next-btn"
                class="w-14 h-14 rounded-full bg-white/10 hover:bg-white/20 text-white transition-all flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                </svg>
            </button>
        </div>

        <!-- Review info -->
        <div class="text-center mb-8">
            <p class="text-gray-400 text-sm">Reviews: <span id="review-count"
                    class="text-primary-400 font-semibold">0</span></p>
        </div>

        <!-- Delete button -->
        <div class="text-center">
            <button id="delete-btn"
                class="text-red-400 hover:text-red-300 text-sm flex items-center space-x-2 mx-auto transition-colors">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16">
                    </path>
                </svg>
                <span>Delete this card</span>
            </button>
        </div>
    </div>

    <!-- Vocabulary List -->
    <div class="mt-12">
        <h2 class="text-2xl font-bold text-white mb-6 flex items-center space-x-3">
            <svg class="w-6 h-6 text-primary-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M4 6h16M4 10h16M4 14h16M4 18h16"></path>
            </svg>
            <span>All Vocabulary</span>
        </h2>

        <div id="vocab-list" class="glass-dark rounded-2xl overflow-hidden">
            <div class="flex items-center justify-center py-8">
                <div class="spinner"></div>
            </div>
        </div>
    </div>
</div>

<!-- Audio Player -->
<audio id="audio-player" class="hidden"></audio>
{% endblock %}

{% block scripts %}
<script>
    // State
    let vocabulary = [];
    let currentIndex = 0;

    // DOM Elements
    const emptyState = document.getElementById('empty-state');
    const flashcardSection = document.getElementById('flashcard-section');
    const flashcard = document.getElementById('flashcard');
    const vocabList = document.getElementById('vocab-list');
    const audioPlayer = document.getElementById('audio-player');

    // Fetch vocabulary
    const fetchVocabulary = async () => {
        try {
            const response = await fetch('/api/vocabulary');
            vocabulary = await response.json();

            updateStats();
            renderVocabList();

            if (vocabulary.length === 0) {
                emptyState.classList.remove('hidden');
                flashcardSection.classList.add('hidden');
            } else {
                emptyState.classList.add('hidden');
                flashcardSection.classList.remove('hidden');
                showCard(0);
            }

        } catch (error) {
            console.error('Failed to fetch vocabulary:', error);
            vocabList.innerHTML = '<p class="text-red-400 text-center py-8">Failed to load vocabulary</p>';
        }
    };

    // Update stats
    const updateStats = () => {
        document.getElementById('total-cards').textContent = vocabulary.length;

        const today = new Date().toDateString();
        const reviewedToday = vocabulary.filter(v =>
            v.last_reviewed && new Date(v.last_reviewed).toDateString() === today
        ).length;
        document.getElementById('reviewed-today').textContent = reviewedToday;

        const mastered = vocabulary.filter(v => v.review_count >= 5).length;
        document.getElementById('mastered').textContent = mastered;

        document.getElementById('card-count').textContent = vocabulary.length;
    };

    // Get level class
    const getLevelClass = (level) => {
        switch (level) {
            case 'A1': return 'level-a1';
            case 'A2': return 'level-a2';
            case 'B1': return 'level-b1';
            default: return 'bg-gray-600';
        }
    };

    // Show card
    const showCard = (index) => {
        if (vocabulary.length === 0) return;

        currentIndex = index;
        const card = vocabulary[currentIndex];

        // Reset flip
        flashcard.classList.remove('flipped');

        // Update content
        document.getElementById('card-word').textContent = card.word;
        document.getElementById('card-translation').textContent = card.translation;
        document.getElementById('card-context').textContent = card.context ? `From: ${card.context}` : '';
        document.getElementById('card-level').textContent = card.level || '';
        document.getElementById('card-level').className = `absolute top-4 right-4 px-3 py-1 rounded-full text-xs font-bold text-white ${getLevelClass(card.level)}`;
        document.getElementById('review-count').textContent = card.review_count;
        document.getElementById('current-index').textContent = currentIndex + 1;

        // Update navigation buttons
        document.getElementById('prev-btn').disabled = currentIndex === 0;
        document.getElementById('next-btn').disabled = currentIndex === vocabulary.length - 1;
    };

    // Render vocabulary list
    const renderVocabList = () => {
        if (vocabulary.length === 0) {
            vocabList.innerHTML = '<p class="text-gray-500 text-center py-8">No vocabulary saved yet</p>';
            return;
        }

        vocabList.innerHTML = `
            <table class="w-full">
                <thead class="bg-white/5">
                    <tr>
                        <th class="text-left py-4 px-6 text-gray-400 font-medium">Word</th>
                        <th class="text-left py-4 px-6 text-gray-400 font-medium">Translation</th>
                        <th class="text-left py-4 px-6 text-gray-400 font-medium">Level</th>
                        <th class="text-left py-4 px-6 text-gray-400 font-medium">Reviews</th>
                        <th class="text-right py-4 px-6 text-gray-400 font-medium">Actions</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-white/5">
                    ${vocabulary.map((v, i) => `
                        <tr class="hover:bg-white/5 transition-colors">
                            <td class="py-4 px-6 font-medium text-white">${v.word}</td>
                            <td class="py-4 px-6 text-primary-300">${v.translation}</td>
                            <td class="py-4 px-6">
                                <span class="px-2 py-1 rounded-md text-xs font-bold text-white ${getLevelClass(v.level)}">${v.level || '-'}</span>
                            </td>
                            <td class="py-4 px-6">
                                <span class="text-gray-400">${v.review_count}x</span>
                                ${v.review_count >= 5 ? '<span class="ml-2 text-green-400">âœ“</span>' : ''}
                            </td>
                            <td class="py-4 px-6 text-right">
                                <button onclick="speakWord('${v.word}')" class="text-primary-400 hover:text-primary-300 mr-3">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z"></path>
                                    </svg>
                                </button>
                                <button onclick="deleteVocab(${v.id})" class="text-red-400 hover:text-red-300">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                    </svg>
                                </button>
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        `;
    };

    // Flip card
    flashcard.addEventListener('click', () => {
        flashcard.classList.toggle('flipped');
    });

    // Navigation
    document.getElementById('prev-btn').addEventListener('click', () => {
        if (currentIndex > 0) showCard(currentIndex - 1);
    });

    document.getElementById('next-btn').addEventListener('click', () => {
        if (currentIndex < vocabulary.length - 1) showCard(currentIndex + 1);
    });

    // Shuffle
    document.getElementById('shuffle-btn').addEventListener('click', () => {
        for (let i = vocabulary.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [vocabulary[i], vocabulary[j]] = [vocabulary[j], vocabulary[i]];
        }
        showCard(0);
        showToast('Cards shuffled!', 'success');
    });

    // Speak
    const speakWord = async (word) => {
        try {
            const response = await fetch('/api/tts', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ text: word })
            });

            const blob = await response.blob();
            const url = URL.createObjectURL(blob);
            audioPlayer.src = url;
            audioPlayer.play();
        } catch (error) {
            console.error('TTS failed:', error);
            showToast('Failed to play audio', 'error');
        }
    };

    document.getElementById('speak-btn').addEventListener('click', () => {
        if (vocabulary.length > 0) {
            speakWord(vocabulary[currentIndex].word);
        }
    });

    // Mark as reviewed
    document.getElementById('review-btn').addEventListener('click', async () => {
        if (vocabulary.length === 0) return;

        const card = vocabulary[currentIndex];

        try {
            const response = await fetch(`/api/vocabulary/${card.id}/review`, {
                method: 'PUT'
            });

            if (response.ok) {
                const updated = await response.json();
                vocabulary[currentIndex] = updated;
                document.getElementById('review-count').textContent = updated.review_count;
                updateStats();
                renderVocabList();
                showToast('Marked as reviewed!', 'success');

                // Auto-advance to next card
                if (currentIndex < vocabulary.length - 1) {
                    setTimeout(() => showCard(currentIndex + 1), 500);
                }
            }
        } catch (error) {
            console.error('Review failed:', error);
            showToast('Failed to mark as reviewed', 'error');
        }
    });

    // Delete vocabulary
    const deleteVocab = async (id) => {
        if (!confirm('Are you sure you want to delete this word?')) return;

        try {
            const response = await fetch(`/api/vocabulary/${id}`, {
                method: 'DELETE'
            });

            if (response.ok) {
                vocabulary = vocabulary.filter(v => v.id !== id);
                updateStats();
                renderVocabList();
                updateVocabCount();

                if (vocabulary.length === 0) {
                    emptyState.classList.remove('hidden');
                    flashcardSection.classList.add('hidden');
                } else {
                    if (currentIndex >= vocabulary.length) currentIndex = vocabulary.length - 1;
                    showCard(currentIndex);
                }

                showToast('Word deleted!', 'success');
            }
        } catch (error) {
            console.error('Delete failed:', error);
            showToast('Failed to delete word', 'error');
        }
    };

    document.getElementById('delete-btn').addEventListener('click', () => {
        if (vocabulary.length > 0) {
            deleteVocab(vocabulary[currentIndex].id);
        }
    });

    // Keyboard navigation
    document.addEventListener('keydown', (e) => {
        if (e.key === 'ArrowLeft') document.getElementById('prev-btn').click();
        if (e.key === 'ArrowRight') document.getElementById('next-btn').click();
        if (e.key === ' ') {
            e.preventDefault();
            flashcard.click();
        }
        if (e.key === 'Enter') document.getElementById('review-btn').click();
    });

    // Initialize
    fetchVocabulary();
</script>
{% endblock %}